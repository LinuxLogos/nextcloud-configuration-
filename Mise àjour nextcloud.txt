Voici une proc√©dure d√©taill√©e pour mettre √† jour Nextcloud sans modifier les donn√©es utilisateurs ni les configurations, en tenant compte de votre architecture :

üìù Pr√©requis
Nextcloud install√© : Chemin local /var/www/nextcloud/ (√† adapter si diff√©rent).

Donn√©es utilisateurs : Stock√©es sur le Windows Server (\\192.168.4.3\Partage\Partage-Nextcloud mont√© en /mnt/nextcloud_data).

Adresse IP du serveur Nextcloud : 192.168.1.15.

Sauvegarde : V√©rifiez que /mnt/nextcloud_data est accessible et contient bien les donn√©es.

üîÑ √âtapes de mise √† jour
1. Pr√©paration
Activer le mode maintenance :

bash
sudo -u www-data php /var/www/nextcloud/occ maintenance:mode --on
V√©rifier la version actuelle :

bash
sudo -u www-data php /var/www/nextcloud/occ status
Sauvegarder la config (au cas o√π) :

bash
cp /var/www/nextcloud/config/config.php /var/www/nextcloud/config/config.php.bak
2. T√©l√©chargement de la nouvelle version
T√©l√©charger la derni√®re version (ex. 31.0.5) :

bash
wget https://download.nextcloud.com/server/releases/nextcloud-31.0.5.zip -P /tmp/
unzip /tmp/nextcloud-31.0.5.zip -d /tmp/
Arr√™ter le serveur web :

bash
sudo systemctl stop apache2  # ou `nginx`
3. Mise √† jour propre
Copier les nouveaux fichiers (sans √©craser data/ et config/) :

bash
rsync -a --delete --exclude=/data/ --exclude=/config/ --exclude=/themes/ /tmp/nextcloud/ /var/www/nextcloud/
--exclude garantit que donn√©es, configs et th√®mes personnalis√©s ne sont pas modifi√©s.

Restaurer les permissions :

bash
chown -R www-data:www-data /var/www/nextcloud/
chmod -R 750 /var/www/nextcloud/
4. Reconfiguration des donn√©es externes
V√©rifier le montage du partage Windows :

bash
mount | grep /mnt/nextcloud_data
Si non mont√©, remonter avec :

bash
sudo mount -t cifs -o username=user,password=pass //192.168.4.3/Partage/Partage-Nextcloud /mnt/nextcloud_data
Lier le dossier de donn√©es (si configur√© dans config.php) :
V√©rifiez que datadirectory pointe bien vers /mnt/nextcloud_data dans /var/www/nextcloud/config/config.php :

php
'datadirectory' => '/mnt/nextcloud_data',
5. Post-mise √† jour
Red√©marrer le serveur web :

bash
sudo systemctl start apache2
D√©sactiver le mode maintenance :

bash
sudo -u www-data php /var/www/nextcloud/occ maintenance:mode --off
Lancer la mise √† jour de la base de donn√©es :

bash
sudo -u www-data php /var/www/nextcloud/occ upgrade
Scanner les fichiers :

bash
sudo -u www-data php /var/www/nextcloud/occ files:scan --all
6. V√©rifications finales
V√©rifier l‚Äô√©tat :

bash
sudo -u www-data php /var/www/nextcloud/occ status
Contr√¥ler les logs :

bash
tail -f /var/www/nextcloud/data/nextcloud.log
Acc√®s via l'interface web :
Ouvrez http://192.168.1.15/nextcloud et v√©rifiez que tout fonctionne.

üîß Gestion des erreurs courantes
Probl√®me de permissions :

bash
chown -R www-data:www-data /var/www/nextcloud/
Fichiers manquants : Relancer occ upgrade ou v√©rifier les logs.

Connexion au partage Windows :
V√©rifiez que le partage est accessible en lecture/√©criture par l‚Äôutilisateur www-data.

üìå Notes importantes
Apps tierces : D√©sactivez-les avant la mise √† jour (occ app:list + occ app:disable NOM_APP).

Sauvegarde suppl√©mentaire : Si possible, sauvegardez aussi la base de donn√©es MySQL/MariaDB.

Test : Si possible, testez la proc√©dure dans un environnement de staging avant la prod.

Cette m√©thode pr√©serve 100% des donn√©es et configurations tout en mettant √† jour le c≈ìur de Nextcloud.

